<html>

<head>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <link href="css.css" rel="stylesheet">
</head>

<body>
    <div id="votesContainer" class="container-fluid"></div>
    <script>
    $.ajax({
        url: 'test.php'
    }).done(function(data) {
        var messages = JSON.parse(data);
        var members = [];
        var votesArray = [];

        messages.forEach(function(message) {
            if (message.embeds) {
                if (message.embeds[0]) {
                    if (checkDups(members, message.author.id) == false && message.author.id != '301368522834182145') {
                        var vote = {};
                        members.push(message.author.id);

                        vote['author'] = message.author;
                        vote['embed'] = message.embeds[0];
                        votesArray.push(vote);
                    }
                }
            }
        });
        if (votesArray.length > 0) {
            submitVotes(votesArray);
        }
    });

    function checkDups(members, memberCheck) {
        var status = false;
        members.forEach(function(member) {
            if (memberCheck == member) {
                status = true;
            }
        });
        return status;
    }

    function formatYoutubeUrl(url) {
        var videoid = url.match(/(?:https?:\/{2})?(?:w{3}\.)?youtu(?:be)?\.(?:com|be)(?:\/watch\?v=|\/)([^\s&]+)/);
        return videoid[1];
    }

    function submitVotes(votesArray) {
        var url = 'https://strawpoll.me/api/v2/polls';
        var date = new Date();
        var pollTitle = 'Disappointed_SongVote';
        var form_data = new FormData();

        form_data.append('title', pollTitle);

        var optionsArray = [];
        votesArray.forEach(function(vote, index) {
            optionsArray.push(vote.embed.url);
        });
        form_data.append('options', JSON.stringify(optionsArray));

        $.ajax({
            url: 'strawpollsubmit.php',
            cache: false,
            contentType: false,
            processData: false,
            data: form_data,
            type: "POST"
        }).done(function(response) {
            response = JSON.parse(response);
            for (var i = 0; i < response.options.length; i++) {
                try {
                    var item = document.createElement('div');
                    var iframe = document.createElement('iframe');

                    $(iframe).addClass('embed-responsive-item');
                    $(item).addClass('col-lg-3 col-md-3 item embed-responsive');

                    var yt_id = formatYoutubeUrl(response.options[i]);
                    $(iframe).attr('src', 'https://www.youtube.com/embed/' + yt_id);

                    $(item).append(iframe);
                    $('#votesContainer').append(item);
                } catch (err) {
                    console.log(err);
                }

            }
        });
    }
    </script>
</body>

</html>
<script>
var testResponse = {
    "id": 12902641,
    "title": "Disappointed_SongVote",
    "options": ["https://www.youtube.com/watch?v=nqtobIpZt68", "http://www.worldstarhiphop.com/videos/video.php?v=wshhH6jc9bDhsizBFy8F", "https://www.youtube.com/watch?v=k85mRPqvMbE", "https://www.youtube.com/watch?v=XyzN9G0QWIM", "https://www.youtube.com/watch?v=6jJkdRaa04g", "https://www.youtube.com/watch?v=qRININJJodM", "https://www.youtube.com/watch?v=B0yGvypBwyA", "https://www.youtube.com/watch?v=jFfobGN9wyg", "https://www.youtube.com/watch?v=x4iBBfEHNaE", "https://www.youtube.com/watch?v=YidMngM4u1U", "https://www.youtube.com/watch?v=so5XDNmFtd4", "https://www.youtube.com/watch?v=4ntk7V6km3k"],
    "votes": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    "multi": false,
    "dupcheck": "normal",
    "captcha": false
};
</script>
